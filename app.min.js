/* Initialize Data Items */
var itemsToInitialize = {
  curPage: "Home",
  curTab: "advanced",
  standardize_pred: true,
  internal_cv: true,
  display_graphs: true,
  set_seed_internal_cv: true,
  set_seed_external_cv: true
};

var radioItems = {
  lambda: ['lambda_min', 'lambda_1se']
};

var displayRules = {
  'weight-vec': 'Use Weights',
  'show-on-regularization': 'regularization',
  'show-on-cv': 'internal_cv',
  'show-on-no-cv': ['internal_cv', function(v){return !v} ],
  'show-on-regularization-graph': 'regularization',
  'show-on-external-cv': 'external_cv',
  'show-on-set-seed-external-cv': 'set_seed_external_cv',
  'show-on-set_seed_internal_cv': 'set_seed_internal_cv'
}

/* Types */
var numericTypes = [
  'Int16', 'Int32', 'Int64', 'Float', 'Double', 'FixedDecimal', 'Byte'
];

var stringTypes = [
  'String', 'WString', 'V_String', 'V_WString'
];

var numericAndStringTypes = numericTypes.concat(stringTypes);

Alteryx.Gui.BeforeLoad = function(manager, AlteryxDataItems){
  console.log("Before Load ----");
  var dataItem = makeDataItem(manager, AlteryxDataItems);
  initializeDataItems(dataItem, itemsToInitialize);
  initializeRadioItems(dataItem, radioItems);
  dataItem('Model Name', {value: getDefaultModelName()});
};

Alteryx.Gui.AfterLoad = function(manager){
  console.log("After Load ----");
  makeFieldMap('X Vars', ['numeric', 'string']);
  activateDisplayRules(displayRules);
  Object.keys(radioItems).forEach(syncRadio);
  setupPages();
  hideRegularizationOnXDF();
};

Alteryx.Gui.Annotation = function(manager){
  return manager.GetDataItemByDataName("Model Name").value;
};

function hideRegularizationOnXDF(){
  var manager = Alteryx.Gui.manager;
  if (isXDF(manager)){
    $('#hide-on-xdf').hide();
  }
}

function isXDF(manager){
  if (manager.metaInfo.Get(0)){
    let src = manager.metaInfo.Get(0)._GetFields()[0].strSource;
    try {
      return JSON.parse(src).Context === 'XDF';
    } 
    catch(e) {
      return false;
    }
  } else {
    return false;
  }
}

function setupPages(){
  var manager = Alteryx.Gui.manager;
  var to = manager.GetDataItem('curPage').getValue();
  switchPage(to);
  $('.switch').on('click', function(){
    var to = $(this).data('page');
    switchPage(to);
  });
  $("document").ready(function(){
    $("#header").stick_in_parent();
  });
}

function switchPage(to){
  var manager = Alteryx.Gui.manager;
  var curPage = manager.GetDataItem('curPage');
  var curTab = manager.GetDataItem('curTab');
  curPage.setValue(to);
  if (to === "Customize") {
    $('#page-basic').hide();
    $('#page-customize').show();
    handleTabs(curTab);
  } else {
    $('#page-customize').hide();
    $('#page-basic').show();
    window.dispatchEvent(new Event('resize'));
  }
}

function handleTabs(curTab){
  var activePage = curTab.getValue();
  function setupTab(activePage){
    $('.tabpage').hide();
    $('#tabpage-' + activePage).show();
    $('.tab').removeClass('active');
    $('#' + activePage).addClass('active');
  }
  setupTab(activePage);
  $('.tab').click(function(){
    var activePage = $(this).data('page');
    setupTab(activePage);
    curTab.setValue(activePage);
  });
}
